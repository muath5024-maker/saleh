# ุฅุตูุงุญ ุชุฏูู ูุง ุจุนุฏ ุชุณุฌูู ุงูุฏุฎูู ูู Flutter

## ุงูุชุงุฑูุฎ: 2025-01-07

## ูุธุฑุฉ ุนุงูุฉ
ุชู ุฅุตูุงุญ ุชุฏูู ูุง ุจุนุฏ ุชุณุฌูู ุงูุฏุฎูู ูู Flutter ูุงุณุชุฎุฏุงู ูุธุงู Auth ุงููุฎุตุต ูู Worker ุจุฏูุงู ูู Supabase Auth.

---

## ุงููููุงุช ุงูุชู ุชู ุชุนุฏูููุง

### 1. `lib/core/services/secure_storage_service.dart`
**ุงูุชุบููุฑุงุช:**
- โ ุชุบููุฑ ููุชุงุญ Token ูู `mbuy_jwt_token` ุฅูู `auth_token` ููุง ุทููุจ

**ุงูุฃุณุทุฑ ุงููุนุฏูุฉ:**
- ุงูุณุทุฑ 15: `static const String _keyJwtToken = 'auth_token';`

---

### 2. `lib/features/auth/data/auth_repository.dart`
**ุงูุชุบููุฑุงุช:**
- โ ุฅุถุงูุฉ logs ูุงุถุญุฉ ุนูุฏ ุจุฏุก ุชุณุฌูู ุงูุฏุฎูู (`LOGIN_REQUEST_START`)
- โ ุฅุถุงูุฉ logs ุนูุฏ ุงุณุชูุงู ุงูุฑุฏ ูู `/auth/login` (`LOGIN_RESPONSE`)
- โ ุฅุถุงูุฉ logs ุนูุฏ ุงุณุชุฏุนุงุก `/auth/me` (`AUTH_ME_RESPONSE`)
- โ ุฅุถุงูุฉ ุฏุงูุฉ `verifyAndLoadUser()` ุงูุชู ุชุณุชุฏุนู `/auth/me` ูุชุญูู ูู Token
- โ ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก - ุญุฐู Token ุชููุงุฆูุงู ุนูุฏ ูุดู ุงูุชุญูู

**ุงูุฃุณุทุฑ ุงููุถุงูุฉ/ุงููุนุฏูุฉ:**
- ุงูุณุทูุฑ 59-115: ุชุญุณูู ุฏุงูุฉ `login()` ูุน logs ููุตูุฉ
- ุงูุณุทูุฑ 117-160: ุฅุถุงูุฉ ุฏุงูุฉ `verifyAndLoadUser()` ุงูุฌุฏูุฏุฉ
- ุงูุณุทูุฑ 162-180: ุชุญุณูู ุฏุงูุฉ `getCurrentUser()` ูุน logs

---

### 3. `lib/features/auth/presentation/screens/auth_screen.dart`
**ุงูุชุบููุฑุงุช:**
- โ ุจุนุฏ ูุฌุงุญ `/auth/login` ูุงุณุชูุงู token:
  - ุญูุธ token ูู `flutter_secure_storage` (ูุชู ุชููุงุฆูุงู ูู `AuthRepository.login()`)
  - ุงุณุชุฏุนุงุก `/auth/me` ูุจุงุดุฑุฉ ุนุจุฑ `verifyAndLoadUser()`
  - ุฅุฐุง ูุฌุญ: ุงูุงูุชูุงู ุฅูู RootWidget (`Navigator.pushReplacementNamed('/')`)
  - ุฅุฐุง ูุดู: ุญุฐู token ูุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ ูุงูุจูุงุก ูู ุดุงุดุฉ ุชุณุฌูู ุงูุฏุฎูู

**ุงูุฃุณุทุฑ ุงููุนุฏูุฉ:**
- ุงูุณุทูุฑ 92-142: ุฅุนุงุฏุฉ ูุชุงุจุฉ ููุทู ูุง ุจุนุฏ ุชุณุฌูู ุงูุฏุฎูู

---

### 4. `lib/core/root_widget.dart`
**ุงูุชุบููุฑุงุช:**
- โ ุฅุฒุงูุฉ ุฃู ุงุนุชูุงุฏ ุนูู Supabase Auth
- โ ุงุณุชุฎุฏุงู `verifyAndLoadUser()` ุจุฏูุงู ูู `verifyToken()` + `getCurrentUser()` ูููุตููู
- โ ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก - ุญุฐู Token ุนูุฏ ูุดู ุงูุชุญูู
- โ ุฅุถุงูุฉ logs ูุงุถุญุฉ ูู `_checkAuthState()`
- โ ุงูุชุฃูุฏ ูู ุฃู ุฒุฑ "ุชุฎุทู" ูุง ูุณุชุฎุฏู Supabase Auth

**ุงูุฃุณุทุฑ ุงููุนุฏูุฉ:**
- ุงูุณุทูุฑ 54-174: ุฅุนุงุฏุฉ ูุชุงุจุฉ `_checkAuthState()` ุจุงููุงูู
- ุงูุณุทูุฑ 271-277: ุฅุถุงูุฉ log ุนูุฏ ุงูุถุบุท ุนูู ุฒุฑ "ุชุฎุทู"

---

## ุงูุชุณูุณู ุงูุฌุฏูุฏ ุจุนุฏ ุชุณุฌูู ุงูุฏุฎูู

### ุงูุฎุทูุฉ 1: ุงููุณุชุฎุฏู ูุถุบุท ุนูู "ุชุณุฌูู ุงูุฏุฎูู"
```
LOGIN_REQUEST_START
[AuthRepository] ๐ Logging in: user@example.com
[AuthRepository] ๐ก Endpoint: POST /auth/login
```

### ุงูุฎุทูุฉ 2: ุฅุฑุณุงู ุงูุทูุจ ุฅูู Worker API
```
POST https://misty-mode-b68b.baharista1.workers.dev/auth/login
Body: { "email": "user@example.com", "password": "***" }
```

### ุงูุฎุทูุฉ 3: ุงุณุชูุงู ุงูุฑุฏ ูู Worker API
```
LOGIN_RESPONSE: statusCode=200, body={ok: true, token: "...", user: {...}}
[AuthRepository] โ Login successful - Token saved to secure storage
```

### ุงูุฎุทูุฉ 4: ุญูุธ Token ูู Secure Storage
```
- Token ูุญููุธ ุชุญุช ุงูููุชุงุญ: auth_token
- User ID ูุญููุธ
- User Email ูุญููุธ
```

### ุงูุฎุทูุฉ 5: ุงูุชุญูู ูู Token ุนุจุฑ `/auth/me`
```
[AuthRepository] ๐ก Calling GET /auth/me with Authorization header
GET https://misty-mode-b68b.baharista1.workers.dev/auth/me
Headers: { Authorization: Bearer <token> }
```

### ุงูุฎุทูุฉ 6: ุงุณุชูุงู ุงูุฑุฏ ูู `/auth/me`
```
AUTH_ME_RESPONSE: statusCode=200, body={ok: true, user: {...}}
[AuthRepository] โ User verified and loaded successfully
```

### ุงูุฎุทูุฉ 7: ุงูุงูุชูุงู ุฅูู Home
```
Navigator.pushReplacementNamed('/')
RootWidget ูุชุญูู ูู auth state ููุนุฑุถ:
- MerchantHomeScreen ุฅุฐุง ูุงู role = 'merchant'
- CustomerShell ุฅุฐุง ูุงู role = 'customer'
```

---

## ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก

### ุฅุฐุง ูุดู `/auth/login`:
- ุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ ูููุณุชุฎุฏู
- ุงูุจูุงุก ูู ุดุงุดุฉ ุชุณุฌูู ุงูุฏุฎูู
- ูุง ุญูุธ ุฃู token

### ุฅุฐุง ูุดู `/auth/me` (401 ุฃู 500):
- ุญุฐู token ูู secure storage ุชููุงุฆูุงู
- ุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ ูููุณุชุฎุฏู
- ุงูุจูุงุก ูู ุดุงุดุฉ ุชุณุฌูู ุงูุฏุฎูู
- ุฅุนุงุฏุฉ ุงููุณุชุฎุฏู ูุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู

---

## Logs ุงููุถุงูุฉ

### ุนูุฏ ุจุฏุก ุชุณุฌูู ุงูุฏุฎูู:
```
LOGIN_REQUEST_START
```

### ุนูุฏ ุงุณุชูุงู ุงูุฑุฏ ูู `/auth/login`:
```
LOGIN_RESPONSE: statusCode=200, body={...}
```

### ุนูุฏ ุงุณุชุฏุนุงุก `/auth/me`:
```
AUTH_ME_RESPONSE: statusCode=200, body={...}
```

---

## ุฒุฑ "ุชุฎุทู" (Skip)

- โ ูุง ูุณุชุฎุฏู Supabase Auth
- โ ูุฏุฎู ุงููุณุชุฎุฏู ูู "Guest Mode"
- โ ูุนุฑุถ CustomerShell ุจุฏูู ุชุณุฌูู ุฏุฎูู
- โ ูุง ูุญุงูู ุฅูุดุงุก Session

---

## ุงูุชุญูู ูู Auth State ุนูุฏ ุจุฏุก ุงูุชุทุจูู

### ูู `RootWidget._checkAuthState()`:

1. **ุงูุชุญูู ูู ูุฌูุฏ Token:**
   ```dart
   final isLoggedIn = await AuthRepository.isLoggedIn();
   ```

2. **ุฅุฐุง ููุฌุฏ Token:**
   - ุงุณุชุฏุนุงุก `/auth/me` ููุชุญูู ูู ุตุญุฉ Token
   - ุฌูุจ ุจูุงูุงุช ุงููุณุชุฎุฏู
   - ุฌูุจ role ูู `user_profiles`
   - ุนุฑุถ ุงูุดุงุดุฉ ุงูููุงุณุจุฉ (Merchant ุฃู Customer)

3. **ุฅุฐุง ูู ููุฌุฏ Token:**
   - ุนุฑุถ ุดุงุดุฉ ุชุณุฌูู ุงูุฏุฎูู

4. **ุฅุฐุง ูุดู ุงูุชุญูู:**
   - ุญุฐู Token
   - ุนุฑุถ ุดุงุดุฉ ุชุณุฌูู ุงูุฏุฎูู

---

## ููุงุญุธุงุช ูููุฉ

1. โ **ูุง ููุฌุฏ ุงุณุชุฎุฏุงู ูู Supabase Auth** ูู ุฃู ููุงู
2. โ **Token ูุญููุธ ูู `auth_token`** ูู secure storage
3. โ **ุฌููุน ุงูุทูุจุงุช ุงููุญููุฉ** ุชุณุชุฎุฏู `Authorization: Bearer <token>`
4. โ **Logs ูุงุถุญุฉ** ูู ูู ุฎุทูุฉ ูู ุงูุนูููุฉ
5. โ **ูุนุงูุฌุฉ ุฃุฎุทุงุก ุดุงููุฉ** ูุน ุญุฐู Token ุชููุงุฆูุงู ุนูุฏ ุงููุดู

---

## ุงูุงุฎุชุจุงุฑ

### ุณููุงุฑูู 1: ุชุณุฌูู ุฏุฎูู ูุงุฌุญ
1. ุฅุฏุฎุงู email + password
2. ุงูุถุบุท ุนูู "ุชุณุฌูู ุงูุฏุฎูู"
3. ูุฌุจ ุฃู ูุธูุฑ: `LOGIN_REQUEST_START`
4. ูุฌุจ ุฃู ูุธูุฑ: `LOGIN_RESPONSE: statusCode=200`
5. ูุฌุจ ุฃู ูุธูุฑ: `AUTH_ME_RESPONSE: statusCode=200`
6. ูุฌุจ ุงูุงูุชูุงู ุฅูู Home ุชููุงุฆูุงู

### ุณููุงุฑูู 2: ุชุณุฌูู ุฏุฎูู ูุงุดู (credentials ุฎุงุทุฆุฉ)
1. ุฅุฏุฎุงู email + password ุฎุงุทุฆุฉ
2. ุงูุถุบุท ุนูู "ุชุณุฌูู ุงูุฏุฎูู"
3. ูุฌุจ ุฃู ูุธูุฑ ุฎุทุฃ: "ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุฃู ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ"
4. ูุฌุจ ุงูุจูุงุก ูู ุดุงุดุฉ ุชุณุฌูู ุงูุฏุฎูู

### ุณููุงุฑูู 3: Token ุบูุฑ ุตุงูุญ
1. ุชุณุฌูู ุฏุฎูู ูุงุฌุญ
2. ุญุฐู token ูุฏููุงู ูู secure storage
3. ุฅุนุงุฏุฉ ูุชุญ ุงูุชุทุจูู
4. ูุฌุจ ุฃู ูุธูุฑ ุดุงุดุฉ ุชุณุฌูู ุงูุฏุฎูู (ูุง Home)

---

## ุงูุฎูุงุตุฉ

โ **ุชู ุฅุตูุงุญ ุงูุชุฏูู ุจุงููุงูู!**

- Token ูุญููุธ ูู `auth_token`
- `/auth/me` ููุณุชุฏุนู ูุจุงุดุฑุฉ ุจุนุฏ login
- ุงูุงูุชูุงู ุฅูู Home ุชููุงุฆูุงู ุนูุฏ ุงููุฌุงุญ
- ุญุฐู Token ุชููุงุฆูุงู ุนูุฏ ุงููุดู
- Logs ูุงุถุญุฉ ูู ูู ุฎุทูุฉ
- ูุง ููุฌุฏ ุงุณุชุฎุฏุงู ูู Supabase Auth

---

ุชู ุจูุฌุงุญ! ๐

